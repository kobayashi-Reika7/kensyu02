# POST /api/reservations 401 Unauthorized：原因と対策

## 1. 401 が発生する代表的な原因（優先度順）

| 優先度 | 原因 | 説明 |
|--------|------|------|
| **1** | **IDトークンが送信されていない** | `getIdToken()` が null を返す、または `authHeaders(idToken)` で空の時 `{}` を返すため Authorization ヘッダーが付与されない。 |
| **2** | **Authorization ヘッダー未指定** | フロントの `authHeaders` が `{}` を返すと、バックエンドで `authorization=None` となり即 401。 |
| **3** | **Firebase プロジェクト不一致** | フロントの `VITE_FIREBASE_PROJECT_ID` とバックエンドのサービスアカウントが**別プロジェクト**の場合、`verify_id_token` が失敗する。 |
| **4** | **トークン期限切れ・リフレッシュ失敗** | 長く開いた画面で `getIdToken()` がキャッシュの期限切れトークンを返し、検証で失敗。 |
| **5** | **Firebase Admin SDK 未初期化** | `GOOGLE_APPLICATION_CREDENTIALS` / `FIREBASE_SERVICE_ACCOUNT_JSON` 未設定で `verify_id_token` が例外。 |
| **6** | **Bearer 形式の不備** | トークンが `Bearer ` プレフィックスなし、または空文字の場合、バックエンドが 401 を返す。 |

---

## 2. 修正すべきコード箇所

### フロントエンド
- `services/backend.js`: `createReservationApi` 呼び出し前に idToken の存在チェック
- `pages/ReserveConfirmPage.jsx`: `getIdToken()` の戻り値チェック、401 時の再ログイン案内

### バックエンド
- `main.py`: `_get_bearer_token` の各 401 ケースで `logger.warning` を出力
- `main.py`: `api_create_reservation` 内の `verify_id_token` 例外時に `logger.warning` で詳細を出力

---

## 3. 再発防止のためのチェック・ログ改善案（実装済み）

- **フロント**: idToken 取得失敗時に「再ログインしてください」と明示 ✅
- **フロント**: `getIdToken(true)` でトークン強制リフレッシュ（期限切れ対策） ✅
- **フロント**: `createReservationApi` 呼び出し前に idToken の存在チェック ✅
- **フロント**: 401 時は「セッションが切れました。再ログインしてください。」を表示 ✅
- **バックエンド**: 「Authorization ヘッダーなし」「Bearer 形式不正」「トークン検証失敗」を `logger.warning` で区別して出力 ✅
- **環境確認**: フロントの `VITE_FIREBASE_PROJECT_ID` とバックエンドのサービスアカウント（`.env` の `GOOGLE_APPLICATION_CREDENTIALS` が指す JSON の `project_id`）が**同一**であること
