<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>電卓アプリ</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #d1d5db;
      color: #1f2937;
    }
    .calculator {
      background: #f3f4f6;
      padding: 1.25rem;
      border-radius: 1rem;
      box-shadow:
        0 4px 6px rgba(0, 0, 0, 0.1),
        0 1px 3px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      border: 1px solid #e5e7eb;
    }
    .display {
      width: 100%;
      min-height: 3.5rem;
      padding: 0.75rem 1rem;
      font-size: 1.75rem;
      text-align: right;
      background: #1f2937;
      color: #f9fafb;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      box-sizing: border-box;
      font-variant-numeric: tabular-nums;
      border: 2px solid #374151;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap: 0.5rem;
      width: 100%;
    }
    .btn {
      padding: 1rem 0.75rem;
      font-size: 1.25rem;
      font-weight: 600;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      cursor: pointer;
      background: #ffffff;
      color: #1f2937;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      transition: background 0.1s;
    }
    .btn:active { background: #e5e7eb; }
    .btn-function {
      background: #e5e7eb;
      color: #374151;
    }
    .btn-function:hover { background: #d1d5db; }
    .btn-function:active { background: #9ca3af; }
    .btn-number { background: #ffffff; }
    .btn-number:hover { background: #f9fafb; }
    .btn-operator {
      background: #3b82f6;
      color: #ffffff;
      border-color: #2563eb;
    }
    .btn-operator:hover { background: #2563eb; }
    .btn-operator:active { background: #1d4ed8; }
    .btn-equals {
      background: #16a34a;
      color: #ffffff;
      border-color: #15803d;
    }
    .btn-equals:hover { background: #15803d; }
    .btn-equals:active { background: #166534; }
  </style>
</head>
<body>
  <div class="calculator">
    <div class="display" id="display">0</div>
    <div class="buttons">
      <button class="btn btn-function" data-value="backspace">⌫</button>
      <button class="btn btn-function" data-value="AC">AC</button>
      <button class="btn btn-function" data-value="%">%</button>
      <button class="btn btn-operator" data-value="/">÷</button>
      <button class="btn btn-number" data-value="7">7</button>
      <button class="btn btn-number" data-value="8">8</button>
      <button class="btn btn-number" data-value="9">9</button>
      <button class="btn btn-operator" data-value="*">×</button>
      <button class="btn btn-number" data-value="4">4</button>
      <button class="btn btn-number" data-value="5">5</button>
      <button class="btn btn-number" data-value="6">6</button>
      <button class="btn btn-operator" data-value="-">−</button>
      <button class="btn btn-number" data-value="1">1</button>
      <button class="btn btn-number" data-value="2">2</button>
      <button class="btn btn-number" data-value="3">3</button>
      <button class="btn btn-operator" data-value="+">+</button>
      <button class="btn btn-number" data-value="±">±</button>
      <button class="btn btn-number" data-value="0">0</button>
      <button class="btn btn-number" data-value=".">.</button>
      <button class="btn btn-equals" data-value="=">=</button>
    </div>
  </div>

  <script>
    /**
     * 電卓アプリ（実機電卓同様の挙動・初心者向け）
     * 表示は常に1行のみ
     */

    const displayElement = document.getElementById('display');

    let displayValue = '0';           // 表示用（1行）
    let currentValue = '0';           // 現在入力中の数値
    let previousValue = null;         // 第1オペランド
    let currentOperator = null;       // 現在の演算子
    let lastOperand2 = null;          // 連続「=」用の第2オペランド

    function toDisplayOp(op) {
      if (op === '*') return '×';
      if (op === '/') return '÷';
      if (op === '-') return '−';
      return op;
    }

    function updateDisplay() {
      displayElement.textContent = displayValue;
    }

    function isResultDisplayed() {
      return / = -?[\d.]+$/.test(displayValue);
    }

    function isInitialOrEmpty() {
      return displayValue === '0' || displayValue === '' || displayValue === 'Error';
    }

    // 演算子入力直後か（表示が「 op 」で終わっている）
    function isRightAfterOperator() {
      return /[\s]+[+\-×÷\u2212][\s]*$/.test(displayValue);
    }

    // 計算結果を四捨五入し、小数点以下最大10桁で表示用に整形
    function formatResult(num) {
      if (num === 'Error' || typeof num !== 'number' || !isFinite(num)) return String(num);
      const fixed = num.toFixed(10);
      return fixed.replace(/0+$/, '').replace(/\.$/, '');
    }

    // 表示の末尾の数値を newStr に置換。末尾に数値がなければ append
    function replaceLastNumber(newStr) {
      const m = displayValue.match(/-?[\d.]+$/);
      if (m) {
        displayValue = displayValue.slice(0, -m[0].length) + newStr;
      } else {
        displayValue = displayValue + newStr;
      }
    }

    // 数値入力（0〜9）：表示中の値に連結
    function inputNumber(num) {
      if (displayValue === 'Error') {
        displayValue = num === '0' ? '0' : num;
        currentValue = displayValue;
        previousValue = null;
        currentOperator = null;
        lastOperand2 = null;
        updateDisplay();
        return;
      }

      // 結果確定後の数値入力：リセットして新規開始
      if (isResultDisplayed()) {
        displayValue = num === '0' ? '0' : num;
        currentValue = displayValue;
        previousValue = null;
        currentOperator = null;
        lastOperand2 = null;
        updateDisplay();
        return;
      }

      // 小数点：数値未入力または演算子直後は「0.」、同一数値内で1回のみ
      if (num === '.') {
        if (isInitialOrEmpty()) {
          displayValue = '0.';
          currentValue = '0.';
        } else if (isRightAfterOperator()) {
          displayValue = displayValue + '0.';
          currentValue = '0.';
        } else if (!currentValue.includes('.')) {
          currentValue += '.';
          replaceLastNumber(currentValue);
        }
        updateDisplay();
        return;
      }

      // ±
      if (num === '±') {
        if (isInitialOrEmpty() || displayValue === '') {
          displayValue = '0';
          currentValue = '0';
        } else {
          const n = parseFloat(currentValue);
          const newVal = String(-n);
          currentValue = newVal;
          replaceLastNumber(newVal);
        }
        updateDisplay();
        return;
      }

      // 0〜9
      if (isInitialOrEmpty() && num !== '0') {
        displayValue = num;
        currentValue = num;
      } else {
        if (currentValue === '0' && num !== '0') {
          currentValue = num;
          replaceLastNumber(num);
        } else {
          currentValue += num;
          replaceLastNumber(currentValue);
        }
      }
      updateDisplay();
    }

    // バックスペース
    function backspace() {
      if (displayValue === 'Error' || isResultDisplayed()) return;
      if (currentValue.length <= 1) {
        currentValue = '0';
        if (currentOperator !== null) replaceLastNumber('0');
        else displayValue = '0';
      } else {
        currentValue = currentValue.slice(0, -1);
        displayValue = displayValue.slice(0, -1);
      }
      updateDisplay();
    }

    // %：直前の数値を100で割る（単体でも演算中でも使用可能）
    function inputPercent() {
      if (displayValue === 'Error') return;
      if (isResultDisplayed()) return;

      const n = parseFloat(currentValue || '0') / 100;
      const s = String(n);
      currentValue = s;
      replaceLastNumber(s);
      updateDisplay();
    }

    // 演算子入力
    function inputOperator(operator) {
      if (displayValue === 'Error') return;

      // 結果確定後の演算子：前回結果を被演算数に使用
      if (isResultDisplayed()) {
        const result = parseFloat(currentValue);
        displayValue = currentValue + ' ' + toDisplayOp(operator) + ' ';
        previousValue = result;
        currentOperator = operator;
        currentValue = '0';
        lastOperand2 = null;
        updateDisplay();
        return;
      }

      const num = parseFloat(currentValue);
      const displayOp = toDisplayOp(operator);

      // 既に演算子が有る場合：連続演算子は最後のみ有効（計算せず置換）
      if (previousValue !== null && currentOperator !== null) {
        const endsWithOp = /[\s]+[+\-×÷\u2212][\s]*$/.test(displayValue);
        if (endsWithOp) {
          displayValue = displayValue.replace(/[\s]+[+\-×÷\u2212][\s]*$/, ' ' + displayOp + ' ');
          currentOperator = operator;
          updateDisplay();
          return;
        }
      }

      // 通常：第1オペランドと演算子を確定
      if (previousValue !== null && currentOperator !== null) {
        const result = calculate(previousValue, num, currentOperator);
        if (result === 'Error') {
          displayValue = 'Error';
          currentValue = 'Error';
          previousValue = null;
          currentOperator = null;
          lastOperand2 = null;
          updateDisplay();
          return;
        }
        previousValue = result;
        lastOperand2 = num;
        currentValue = String(result);
      } else {
        previousValue = num;
      }
      displayValue = String(previousValue) + ' ' + displayOp + ' ';
      currentOperator = operator;
      currentValue = '0';
      updateDisplay();
    }

    function calculate(a, b, op) {
      switch (op) {
        case '+': return a + b;
        case '-': return a - b;
        case '*': return a * b;
        case '/': return b === 0 ? 'Error' : a / b;
        default: return b;
      }
    }

    // = 押下
    function executeEquals() {
      if (displayValue === 'Error') return;

      // 結果表示中に = 連続：同じ演算を繰り返す
      if (isResultDisplayed()) {
        if (previousValue === null || currentOperator === null || lastOperand2 === null) return;
        const result = calculate(previousValue, lastOperand2, currentOperator);
        if (result === 'Error') return;
        const resultStr = formatResult(result);
        displayValue = formatResult(previousValue) + ' ' + toDisplayOp(currentOperator) + ' ' + formatResult(lastOperand2) + ' = ' + resultStr;
        currentValue = resultStr;
        previousValue = result;
        updateDisplay();
        return;
      }

      if (previousValue === null || currentOperator === null) return;

      const num = parseFloat(currentValue);
      const result = calculate(previousValue, num, currentOperator);
      const resultStr = result === 'Error' ? 'Error' : formatResult(result);

      const endsWithOp = /[\s]+[+\-×÷\u2212][\s]*$/.test(displayValue);
      displayValue = endsWithOp
        ? displayValue + currentValue + ' = ' + resultStr
        : displayValue + ' = ' + resultStr;

      currentValue = resultStr;
      if (result === 'Error') {
        previousValue = null;
        currentOperator = null;
        lastOperand2 = null;
      } else {
        previousValue = parseFloat(resultStr);
        lastOperand2 = num;
      }
      updateDisplay();
    }

    function clearAll() {
      displayValue = '0';
      currentValue = '0';
      previousValue = null;
      currentOperator = null;
      lastOperand2 = null;
      updateDisplay();
    }

    function handleButtonClick(value) {
      if (value >= '0' && value <= '9') inputNumber(value);
      else if (value === '.') inputNumber('.');
      else if (value === '±') inputNumber('±');
      else if (value === 'backspace') backspace();
      else if (value === 'AC') clearAll();
      else if (value === '%') inputPercent();
      else if (value === '=') executeEquals();
      else if (['+', '-', '*', '/'].includes(value)) inputOperator(value);
    }

    document.querySelectorAll('.btn').forEach(function (btn) {
      btn.addEventListener('click', function () { handleButtonClick(btn.dataset.value); });
    });
    updateDisplay();
  </script>
</body>
</html>
