# 精度向上: プロンプト最適化

## 効果的なプロンプトのガイドライン

| ガイドライン | 説明 |
|--------------|------|
| 文脈に含まれる事実のみ使用 | 検索された文書内の情報に限定して回答 |
| 推測や想像を避ける | 不確かな場合は「分からない」と正直に回答 |
| 簡潔で明確な日本語 | 冗長な表現を避け、要点を簡潔に伝える |
| 根拠を示す | 回答の出典となる文書を明示する |
| 役割を明確にする | LLMにアシスタントやエキスパートとしての役割を与える |
| 構造化された回答形式 | 整理された形式で回答するよう指示 |

## プロンプトテンプレート

### 基本的なプロンプト

```python
template = """あなたは専門的なアシスタントです。以下の文脈のみを使用して、質問に正確に答えてください。

文脈:
{context}

質問: {question}

回答:"""
```

### 明示的な指示を含むプロンプト（推奨）

```python
template = """あなたは日本語の質問応答システムです。以下の文脈から質問に答えてください。

【文脈】
{context}

【質問】
{question}

【回答の際の注意点】
・文脈に書かれている事実のみを使用する
・推測や一般知識を混ぜない
・答えられない場合は正直にその旨を伝える
・丁寧で分かりやすい日本語で回答する

【回答】
"""
```

## 実装方法

```python
from langchain_core.prompts import PromptTemplate

prompt = PromptTemplate(
    template=template,
    input_variables=["context", "question"]
)

qa_chain = RetrievalQA.from_chain_type(
    llm=llm,
    chain_type="stuff",
    retriever=vectorstore.as_retriever(),
    chain_type_kwargs={"prompt": prompt}
)
```

## 本番プロンプト（OnsenRAG 現行版）

```python
PROMPT_TEMPLATE = """あなたはRAGシステム専用の日本語質問応答アシスタントです。
以下の【文脈】は、検索によって取得された関連性の高い上位3件の情報です。

【厳守ルール】
- 必ず【文脈】に含まれる事実のみを使用して回答してください
- 文脈に書かれていない内容を推測・補完・一般知識で補わないでください
- 分からない場合は「文脈内に該当情報がないため分かりません」と回答してください
- 根拠となるチャンクID・参照ソース・文書名は一切表示しないでください
- 回答は簡潔で分かりやすい日本語にしてください

【文脈】
{context}

【質問】
{question}

【回答】
"""
```

### 設計ポイント

| 項目 | 旧プロンプト | 現行プロンプト |
|------|------------|--------------|
| 回答形式 | 箇条書き5項目 + チャンクID必須 | 自由形式（簡潔さのみ指定） |
| チャンクID | LLM回答に含める | 非表示（API応答で別途返却） |
| 不明時の応答 | 「該当情報なし」 | 「文脈内に該当情報がないため分かりません」 |
| 文脈の渡し方 | `chunk_id: xxx` プレフィックス付き | 本文のみ（`---` 区切り） |

**チャンクIDを非表示にした理由:**
- ユーザー向けの回答にシステム内部のIDは不要
- チャンクIDはAPI応答の `chunk_ids` フィールドで引き続き返却される
- LLMがIDを出力しようとして回答が冗長になる問題を回避

## ドメイン別のカスタマイズ例

温泉ガイド向けなど、ドメインに応じた参考プロンプト：

```python
template = """
この情報の内容に基づいて質問に答えてください。
推測や記載のない情報は答えないでください。

【参考情報】
{context}

【質問】
{question}

【厳守事項】
・参考情報に含まれない事実や一般知識を使用しない
・推測や想像は行わない
・参考情報から判断できない場合は「参考情報からは分かりません」と回答する
・回答は簡潔で分かりやすい日本語にする

【回答形式】
・結論を最初に述べる
・必要に応じて箇条書きを使用
・根拠となる参考情報の要点を明示する

【回答】
"""
```
