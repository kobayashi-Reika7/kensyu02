<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ToDoアプリ</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", "Meiryo", sans-serif;
      max-width: 560px;
      margin: 0 auto;
      padding: 16px;
      background: #f0f0f0;
    }
    h1 {
      font-size: 1.25rem;
      margin: 0 0 16px 0;
      color: #333;
    }
    /* カウンター：画面上部に未完了・完了件数を表示 */
    .counter-row {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      padding: 10px 14px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      font-size: 0.95rem;
    }
    .counter-row span { color: #555; }
    /* タスク入力フォーム */
    .task-form {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .task-form input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    .task-form button {
      padding: 10px 20px;
      background: #4a90d9;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .task-form button:hover { background: #357abd; }
    /* タスクカード：縦に並べ、カードで区切る */
    .task-list { list-style: none; margin: 0; padding: 0; }
    .task-card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    /* タスク行：チェックボックス・タイトル・編集・削除 */
    .task-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .task-header input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .task-title {
      flex: 1;
      font-size: 1rem;
      border: none;
      background: transparent;
      padding: 4px 0;
    }
    .task-title:focus { outline: none; }
    .task-title.edit-mode {
      border: 1px solid #4a90d9;
      border-radius: 4px;
      padding: 4px 8px;
      background: #fff;
    }
    .task-card.completed .task-title:not(.edit-mode) {
      color: #999;
      text-decoration: line-through;
    }
    .task-header button {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .btn-edit { background: #e8e8e8; }
    .btn-edit:hover { background: #d0d0d0; }
    .btn-delete { background: #f0e0e0; color: #c33; }
    .btn-delete:hover { background: #f0c0c0; }
    /* タイマー行 */
    .timer-row {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .timer-label { font-size: 0.9rem; color: #555; margin-right: 4px; }
    .timer-display { font-size: 1.25rem; font-weight: bold; min-width: 52px; }
    .timer-btns { display: flex; gap: 6px; }
    .timer-btns button {
      padding: 6px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .timer-start { background: #5cb85c; color: #fff; }
    .timer-start:hover { background: #4cae4c; }
    .timer-stop { background: #d9534f; color: #fff; }
    .timer-stop:hover { background: #c9302c; }
    .timer-reset { background: #e0e0e0; }
    .timer-reset:hover { background: #d0d0d0; }
    /* メモ */
    .memo-label { font-size: 0.9rem; color: #555; margin-bottom: 4px; display: block; }
    .memo-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
      font-family: inherit;
      resize: vertical;
    }
  </style>
</head>
<body>
  <h1>ToDoアプリ</h1>
  <div class="counter-row" id="counterRow">
    <span id="counterIncomplete">未完了：0件</span>
    <span id="counterCompleted">完了：0件</span>
  </div>
  <div class="task-form">
    <input type="text" id="taskInput" placeholder="タスクを入力" maxlength="200">
    <button type="button" id="addButton">追加</button>
  </div>
  <ul class="task-list" id="taskList"></ul>

  <script>
    // ===== データ =====
    // タスク一覧。各要素: { id, title, isCompleted, memo, elapsedSeconds }
    // elapsedSeconds は表示用のみ（localStorage には保存しない）
    var tasks = [];
    var nextId = 1;
    var STORAGE_KEY = "todo_app_tasks";

    // 現在動いているタイマーのタスクID（同時に1つだけ）
    var runningTimerTaskId = null;
    var timerStartTime = null;
    var timerIntervalId = null;

    // 経過秒数を mm:ss 形式で返す
    function formatElapsed(seconds) {
      var m = Math.floor(seconds / 60);
      var s = seconds % 60;
      return ("0" + m).slice(-2) + ":" + ("0" + s).slice(-2);
    }

    // localStorage から復元（完了状態・メモのみ。タイマー経過は含めない）
    function loadTasks() {
      try {
        var json = localStorage.getItem(STORAGE_KEY);
        if (json) {
          var saved = JSON.parse(json);
          tasks = saved.map(function (t) {
            return {
              id: t.id,
              title: t.title,
              isCompleted: t.isCompleted === true,
              memo: t.memo || "",
              elapsedSeconds: 0
            };
          });
          var maxId = 0;
          for (var i = 0; i < tasks.length; i++) {
            if (tasks[i].id > maxId) maxId = tasks[i].id;
          }
          nextId = maxId + 1;
        }
      } catch (e) {
        tasks = [];
      }
    }

    // localStorage に保存（id, title, isCompleted, memo のみ）
    function saveTasks() {
      var toSave = tasks.map(function (t) {
        return { id: t.id, title: t.title, isCompleted: t.isCompleted, memo: t.memo };
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
    }

    // 指定タスクの経過表示を更新（稼働中は startTime 基準、停止中は elapsedSeconds）
    function updateTaskTimerDisplay(taskId) {
      var task = getTaskById(taskId);
      if (!task) return;
      var displayEl = document.getElementById("timer-display-" + taskId);
      if (!displayEl) return;
      var seconds;
      if (runningTimerTaskId === taskId && timerStartTime !== null) {
        seconds = task.elapsedSeconds + Math.floor((Date.now() - timerStartTime) / 1000);
      } else {
        seconds = task.elapsedSeconds;
      }
      displayEl.textContent = formatElapsed(seconds);
    }

    function getTaskById(id) {
      for (var i = 0; i < tasks.length; i++) {
        if (tasks[i].id === id) return tasks[i];
      }
      return null;
    }

    // 全タスクのタイマー表示を更新（interval 用）
    function updateAllTimerDisplays() {
      if (runningTimerTaskId !== null) {
        updateTaskTimerDisplay(runningTimerTaskId);
      }
    }

    // タイマーを止める（他タスクのタイマー開始時に呼ぶ）
    function stopAnyRunningTimer() {
      if (timerIntervalId !== null) {
        clearInterval(timerIntervalId);
        timerIntervalId = null;
      }
      if (runningTimerTaskId !== null && timerStartTime !== null) {
        var task = getTaskById(runningTimerTaskId);
        if (task) {
          task.elapsedSeconds += Math.floor((Date.now() - timerStartTime) / 1000);
        }
        runningTimerTaskId = null;
        timerStartTime = null;
      }
    }

    function startTimer(taskId) {
      stopAnyRunningTimer();
      var task = getTaskById(taskId);
      if (!task) return;
      runningTimerTaskId = taskId;
      timerStartTime = Date.now();
      updateTaskTimerDisplay(taskId);
      timerIntervalId = setInterval(updateAllTimerDisplays, 1000);
    }

    function stopTimer(taskId) {
      if (runningTimerTaskId !== taskId) return;
      if (timerIntervalId !== null) {
        clearInterval(timerIntervalId);
        timerIntervalId = null;
      }
      var task = getTaskById(taskId);
      if (task && timerStartTime !== null) {
        task.elapsedSeconds += Math.floor((Date.now() - timerStartTime) / 1000);
      }
      runningTimerTaskId = null;
      timerStartTime = null;
      updateTaskTimerDisplay(taskId);
    }

    function resetTimer(taskId) {
      if (runningTimerTaskId === taskId) {
        stopTimer(taskId);
      }
      var task = getTaskById(taskId);
      if (task) {
        task.elapsedSeconds = 0;
        updateTaskTimerDisplay(taskId);
      }
    }

    // ===== タスクの追加・削除・編集・完了 =====
    function addTask() {
      var input = document.getElementById("taskInput");
      var title = input.value.trim();
      if (title === "") return;
      tasks.push({
        id: nextId,
        title: title,
        isCompleted: false,
        memo: "",
        elapsedSeconds: 0
      });
      nextId += 1;
      input.value = "";
      saveTasks();
      renderTasks();
    }

    function removeTask(taskId) {
      if (runningTimerTaskId === taskId) stopAnyRunningTimer();
      for (var i = 0; i < tasks.length; i++) {
        if (tasks[i].id === taskId) {
          tasks.splice(i, 1);
          break;
        }
      }
      saveTasks();
      renderTasks();
    }

    function toggleCompleted(taskId) {
      var task = getTaskById(taskId);
      if (task) {
        task.isCompleted = !task.isCompleted;
        saveTasks();
        renderTasks();
      }
    }

    function setTaskTitle(taskId, newTitle) {
      var task = getTaskById(taskId);
      if (task) {
        task.title = newTitle.trim() || task.title;
        saveTasks();
        renderTasks();
      }
    }

    function setTaskMemo(taskId, memo) {
      var task = getTaskById(taskId);
      if (task) {
        task.memo = memo;
        saveTasks();
      }
    }

    // ===== カウンター（要件 2.2：関数として分離し、状態変更時に即座に再計算） =====
    // 未完了数・完了数を配列から算出する（保存せず起動時・状態変更時に再計算）
    function getTaskCounts() {
      var incomplete = 0;
      var completed = 0;
      for (var i = 0; i < tasks.length; i++) {
        if (tasks[i].isCompleted) {
          completed += 1;
        } else {
          incomplete += 1;
        }
      }
      return { incomplete: incomplete, completed: completed };
    }

    function updateCounterDisplay() {
      var counts = getTaskCounts();
      document.getElementById("counterIncomplete").textContent = "未完了：" + counts.incomplete + "件";
      document.getElementById("counterCompleted").textContent = "完了：" + counts.completed + "件";
    }

    // ===== 描画 =====
    function renderTasks() {
      var listEl = document.getElementById("taskList");
      listEl.innerHTML = "";
      for (var i = 0; i < tasks.length; i++) {
        var task = tasks[i];
        var card = document.createElement("li");
        card.className = "task-card" + (task.isCompleted ? " completed" : "");
        card.dataset.taskId = task.id;

        // ヘッダー：チェックボックス・タイトル・編集・削除
        var header = document.createElement("div");
        header.className = "task-header";
        var cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = task.isCompleted;
        cb.addEventListener("change", function (id) { return function () { toggleCompleted(id); }; }(task.id));
        var titleSpan = document.createElement("span");
        titleSpan.className = "task-title";
        titleSpan.textContent = task.title;
        titleSpan.contentEditable = "false";
        var editBtn = document.createElement("button");
        editBtn.className = "btn-edit";
        editBtn.textContent = "編集";
        editBtn.addEventListener("click", function (id, span) {
          return function () {
            if (span.classList.contains("edit-mode")) {
              setTaskTitle(id, span.textContent);
              span.classList.remove("edit-mode");
              span.contentEditable = "false";
            } else {
              span.classList.add("edit-mode");
              span.contentEditable = "true";
              span.focus();
              // フォーカスが外れたら保存して編集終了
              function onBlur() {
                setTaskTitle(id, span.textContent);
                span.classList.remove("edit-mode");
                span.contentEditable = "false";
                span.removeEventListener("blur", onBlur);
              }
              span.addEventListener("blur", onBlur);
            }
          };
        }(task.id, titleSpan));
        var deleteBtn = document.createElement("button");
        deleteBtn.className = "btn-delete";
        deleteBtn.textContent = "削除";
        deleteBtn.addEventListener("click", function (id) { return function () { removeTask(id); }; }(task.id));
        header.appendChild(cb);
        header.appendChild(titleSpan);
        header.appendChild(editBtn);
        header.appendChild(deleteBtn);
        card.appendChild(header);

        // タイマー
        var timerRow = document.createElement("div");
        timerRow.className = "timer-row";
        timerRow.innerHTML = "<span class=\"timer-label\">タイマー：</span><span class=\"timer-display\" id=\"timer-display-" + task.id + "\">" + formatElapsed(task.elapsedSeconds) + "</span>";
        var timerBtns = document.createElement("div");
        timerBtns.className = "timer-btns";
        var startBtn = document.createElement("button");
        startBtn.className = "timer-start";
        startBtn.textContent = "開始";
        startBtn.addEventListener("click", function (id) { return function () { startTimer(id); }; }(task.id));
        var stopBtn = document.createElement("button");
        stopBtn.className = "timer-stop";
        stopBtn.textContent = "停止";
        stopBtn.addEventListener("click", function (id) { return function () { stopTimer(id); }; }(task.id));
        var resetBtn = document.createElement("button");
        resetBtn.className = "timer-reset";
        resetBtn.textContent = "リセット";
        resetBtn.addEventListener("click", function (id) { return function () { resetTimer(id); }; }(task.id));
        timerBtns.appendChild(startBtn);
        timerBtns.appendChild(stopBtn);
        timerBtns.appendChild(resetBtn);
        timerRow.appendChild(timerBtns);
        card.appendChild(timerRow);

        // メモ
        var memoLabel = document.createElement("label");
        memoLabel.className = "memo-label";
        memoLabel.textContent = "メモ：";
        var memoArea = document.createElement("textarea");
        memoArea.className = "memo-textarea";
        memoArea.placeholder = "メモを入力";
        memoArea.value = task.memo;
        memoArea.addEventListener("input", function (id) {
          return function () { setTaskMemo(id, this.value); };
        }(task.id));
        card.appendChild(memoLabel);
        card.appendChild(memoArea);

        listEl.appendChild(card);
      }
      // 状態変更時にカウンターを即座に更新
      updateCounterDisplay();
    }

    // ===== 初期化 =====
    document.getElementById("addButton").addEventListener("click", addTask);
    document.getElementById("taskInput").addEventListener("keydown", function (e) {
      if (e.key === "Enter") addTask();
    });

    loadTasks();
    renderTasks();
  </script>
</body>
</html>
